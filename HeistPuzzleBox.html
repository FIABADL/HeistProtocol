<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heist Puzzle Box — Intro + Wires • Laser • Transfer</title>
  <style>
    body { margin:0; font-family:'Courier New', monospace; background:#000; color:#0f0; overflow:hidden; }
    #matrix { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-2; }
    .hidden { display:none !important; }
    #app { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; padding:1em; }
    @keyframes shake { 0%,100%{transform:translate(0);}25%{transform:translate(2px);}50%{transform:translate(-2px);}75%{transform:translate(2px);} }
    .shake { animation:shake .5s; }
    .screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:1.2em; border-radius:8px; width:90%; max-width:420px; box-sizing:border-box; }
    @media (max-width:600px){ .screen{ top:45%; transform:translate(-50%,-45%); padding:0.9em; max-width:90%; } }
    .screen h1, .screen h2 { margin-bottom:0.5em; }
    .screen p { margin-bottom:1em; line-height:1.3; }
    .screen button { background:transparent; color:#0f0; border:1px solid #0f0; padding:0.5em 1em; cursor:pointer; margin:0.3em; user-select:none; -webkit-user-select:none; }

    /* Code panel pinned top */
    #code-panel { position:fixed; top:8px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); border:1px solid #0f0; border-radius:6px; padding:6px 10px; font-size:1rem; z-index:3; }
    #code-digits { letter-spacing:.3em; font-weight:bold; }

    /* Transition overlay */
    #transition { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.92); display:none; align-items:center; justify-content:center; z-index:4; text-align:center; padding:1rem; }
    .show-transition { display:flex !important; }
    #transition .box { border:1px solid #0f0; border-radius:8px; padding:1rem 1.25rem; max-width:520px; }

    /* Wires */
    #wire-module { background:rgba(0,0,0,0.8); padding:1em; border-radius:8px; width:90%; max-width:420px; }
    #manual-note { font-size:0.9em; margin-bottom:1em; border:1px dashed #0f0; padding:0.5em; }
    #serial { font-size:1.1em; margin-bottom:1em; }
    #wire-container { display:flex; flex-direction:column; gap:0.5em; }
    .wire { display:flex; align-items:center; gap:0.5em; }
    .wire .label { flex:1; text-align:left; }
    .wire-graphic { flex:2; font-family:'Courier New', monospace; text-align:center; }

    /* Laser (mobile-optimized) */
    #laser-module { background:rgba(0,0,0,0.8); padding:0.8em; border-radius:8px; width:90%; max-width:360px; }
    #laser-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:5px; margin-top:6px; }
    .laser-cell { border:1px solid #0f0; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; cursor:pointer; background:rgba(0,0,0,0.5); }
    .laser-cell:hover { background:rgba(0,255,0,0.08); }
    img#laser-img { width:100%; border:1px solid #0f0; margin-bottom:6px; max-height:150px; object-fit:contain; }

    /* Transfer Bars */
    #transfer-module { background:rgba(0,0,0,0.9); padding:1.2em; border-radius:8px; width:90%; max-width:420px; }
    #transfer-title { color:#0f0; font-weight:bold; margin-bottom:.25em; }
    #transfer-bar { width:100%; height:16px; border:1px solid #0f0; border-radius:6px; position:relative; overflow:hidden; background:rgba(0,255,0,0.05); margin:10px 0; }
    #transfer-bar-fill { position:absolute; left:0; top:0; height:100%; width:0%; background:#0f0; transition:width 0.05s linear; }
    #transfer-percent { margin-top:.4em; }
    #trace { color:#f33; font-weight:bold; margin:.6em 0; display:none; }

    video { width:100%; border:1px solid #0f0; border-radius:8px; background:#000; }
  </style>
</head>
<body>
  <audio id="bg-music" src="./Radional.mp3" loop preload="auto"></audio>
  <canvas id="matrix"></canvas>

  <div id="app">
    <!-- START (no Instructions button) -->
    <div id="start-screen" class="screen">
      <h1>Heist Protocol</h1>
      <p>Authorization incoming from Chris Moran…</p>
      <button id="start-btn">Start</button>
    </div>

    <!-- INTRO VIDEO (auto-plays after Start) -->
    <div id="intro-video" class="screen hidden">
      <video id="heist-video" src="HeistProtocol_Intro.mp4" preload="auto"></video>
    </div>

    <!-- CODE PANEL (pinned top) -->
    <div id="code-panel" class="hidden">Vault Code: <span id="code-digits">_ _ _ _</span></div>

    <!-- Transition overlay screen -->
    <div id="transition" class="hidden" aria-hidden="true" style="display:none">
      <div class="box">
        <div id="transition-text"></div>
      </div>
    </div>

    <!-- WIRES MODULE -->
    <div id="wire-module" class="screen hidden">
      <h2>Module: Wire Control</h2>
      <p id="manual-note">Partner notes were useless. You're the professional now.</p>
      <div id="serial"></div>
      <div id="wire-container"></div>
      <p id="feedback"></p>
      <button id="wire-next-module" class="hidden">Next Module</button>
    </div>

    <!-- LASER MODULE -->
    <div id="laser-module" class="screen hidden">
      <h2>Module: Laser System</h2>
      <img id="laser-img" src="LaserDevice.png" alt="Laser grid"/>
      <div id="laser-grid"></div>
      <p id="laser-feedback"></p>
      <button id="laser-next-module" class="hidden">Next Module</button>
    </div>

    <!-- TRANSFER BARS MODULE -->
    <div id="transfer-module" class="screen hidden">
      <h2>Module: Transfer Bars</h2>
      <div id="transfer-title">Transferring Encrypted Files…</div>
      <div id="transfer-bar"><div id="transfer-bar-fill"></div></div>
      <div id="transfer-percent">0%</div>
      <div id="trace">TRACE INITIATED!</div>
      <div><button id="abort-btn">ABORT TRANSFER</button></div>
      <p id="transfer-feedback"></p>
    </div>

    <!-- CAMERA MODULE -->
    <div id="camera-module" class="screen hidden">
      <h2>Module: Camera Review</h2>
      <video id="cam-video" src="HeistProtocol_Camera.mp4" preload="auto" controls></video>
      <p id="cam-instructions" style="margin-top:.5em;">Watch the footage, then enter the 4‑digit code you observed.</p>
      <div style="display:flex; gap:.5em; justify-content:center; margin-top:.25em;">
        <input id="cam-code" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="----" style="width:7em; text-align:center; background:#000; color:#0f0; border:1px solid #0f0; border-radius:6px; padding:.4em .5em;"/>
        <button id="cam-submit">Submit</button>
      </div>
      <p id="cam-feedback"></p>
    </div>
  </div>

  <script>
    // ===== Matrix rain =====
    const canvas = document.getElementById('matrix'), ctx = canvas.getContext('2d');
    function sizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    sizeCanvas(); window.addEventListener('resize', sizeCanvas);
    let cols = Math.floor(canvas.width/20)+1, ypos = Array(cols).fill(0);
    setInterval(() => {
      if (cols !== Math.floor(canvas.width/20)+1) { cols = Math.floor(canvas.width/20)+1; ypos = Array(cols).fill(0); }
      ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#0f0'; ctx.font = '16px Courier New';
      ypos.forEach((y,i) => { ctx.fillText(Math.random()>0.5?'1':'0', i*20, y); ypos[i] = y > canvas.height ? 0 : y + 20; });
    },50);

    // ===== Transition overlay helper =====
    function showTransition(text, duration=2200, next){
      const el = document.getElementById('transition');
      const txt = document.getElementById('transition-text');
      txt.textContent = text || '';
      el.classList.add('show-transition');
      el.style.display = 'flex';
      el.setAttribute('aria-hidden','false');
      setTimeout(()=>{
        el.classList.remove('show-transition');
        el.style.display = 'none';
        el.setAttribute('aria-hidden','true');
        if(typeof next === 'function') next();
      }); // duration arg removed to avoid stray comma parse error
    }

    // ===== Vault code state =====
    const codeDigits = [null, null, null, null];
    function renderCodePanel(){
      const panel = document.getElementById('code-panel');
      const s = codeDigits.map(d => d===null ? '_' : d).join(' ');
      document.getElementById('code-digits').textContent = s;
      panel.classList.remove('hidden');
    }
    function setCodeDigit(pos, val){ if(codeDigits[pos]===null){ codeDigits[pos] = val; renderCodePanel(); } }

    // ===== START: play intro video then begin modules =====
    document.getElementById('start-btn').addEventListener('click',()=>{
      const bg = document.getElementById('bg-music'); bg.play().catch(()=>{});
      document.getElementById('start-screen').classList.add('hidden');
      const intro = document.getElementById('intro-video');
      const vid = document.getElementById('heist-video');
      intro.classList.remove('hidden'); vid.currentTime = 0; vid.play().catch(()=>{});
      vid.onended = () => {
        intro.classList.add('hidden');
        renderCodePanel();
        document.getElementById('wire-module').classList.remove('hidden');
        initWires();
        showTransition("Chris’s token accepted. You’re clear to continue — he’s still driving.", 2200);
      };
    });

    // ===== Wires logic =====
    let wires = [], serialNumber = '', lastDigitOdd = false;
    function randomizeWires() {
      serialNumber = String(Math.floor(Math.random()*1e6)).padStart(6,'0');
      lastDigitOdd = parseInt(serialNumber.slice(-1)) % 2 === 1;
      document.getElementById('serial').textContent = `SN: ${serialNumber}`;
      const colors = ['red','white','blue','yellow','black'];
      const len = 3 + Math.floor(Math.random()*4); // 3..6 wires
      wires = Array.from({length:len}, () => colors[Math.floor(Math.random()*colors.length)]);
    }
    function getCorrectWire() {
      const cnt = c => wires.filter(w=>w===c).length, l = wires.length;
      if(l===3){ if(cnt('red')===0) return 1; if(wires[2]==='white') return 2; if(cnt('blue')>1) return wires.lastIndexOf('blue'); return 2; }
      if(l===4){ if(cnt('red')>1&&lastDigitOdd) return wires.lastIndexOf('red'); if(wires[3]==='yellow'&&cnt('red')===0) return 0; if(cnt('blue')===1) return 0; if(cnt('yellow')>1) return 3; return 1; }
      if(l===5){ if(wires[4]==='black'&&lastDigitOdd) return 3; if(cnt('red')===1&&cnt('yellow')>1) return 0; if(cnt('black')===0) return 1; return 0; }
      if(l===6){ if(cnt('yellow')===0&&lastDigitOdd) return 2; if(cnt('yellow')===1&&cnt('white')>1) return 3; if(cnt('red')===0) return 5; return 3; }
      return 0;
    }
    function initWires() {
      randomizeWires();
      document.getElementById('feedback').textContent = '';
      const ctr = document.getElementById('wire-container'); ctr.innerHTML = '';
      wires.forEach((col,i) => {
        const dashes = '─'.repeat(20);
        const div = document.createElement('div'); div.className = 'wire';
        div.innerHTML = `<span class=\"label\">Wire ${i+1} (${col})</span>`+
                        `<span id=\"wire-graphic-${i}\" class=\"wire-graphic\" style=\"color:${col};\">${dashes}</span>`+
                        `<button class=\"cut-button\" data-i=\"${i}\">Cut</button>`;
        ctr.appendChild(div);
      });
      document.querySelectorAll('.cut-button').forEach(b=>b.addEventListener('click', handleCut));
      document.getElementById('wire-next-module').classList.add('hidden');
    }
    function handleCut(e) {
      const idx = +e.target.dataset.i, correct = getCorrectWire();
      const gr = document.getElementById(`wire-graphic-${idx}`);
      if(gr){ const t = gr.textContent, m = Math.floor(t.length/2); gr.textContent = t.slice(0,m)+'  '+t.slice(m+2); }
      if(idx===correct){
        document.getElementById('feedback').textContent='✅ Disarmed. (Digit revealed: 8)';
        setCodeDigit(0, 8);
        // Transition then auto-advance to Laser
        showTransition('File fragment received. Chris says, “Hurry, but don’t break anything.”', 2200, ()=>{
          document.getElementById('wire-module').classList.add('hidden');
          document.getElementById('laser-module').classList.remove('hidden');
          initLaser();
        });
      } else {
        document.getElementById('feedback').textContent='❌ Wrong. Try another wire.';
        document.getElementById('app').classList.add('shake');
        setTimeout(()=>document.getElementById('app').classList.remove('shake'),500);
      }
    }

    // ===== Laser module (mobile-optimized) =====
    const LASER_ROWS=5, LASER_COLS=5, LASER_CORRECT={row:4,col:2}; // bottom middle (0-based)
    function initLaser(){
      const grid=document.getElementById('laser-grid'); grid.innerHTML='';
      document.getElementById('laser-feedback').textContent='';
      for(let r=0;r<LASER_ROWS;r++){
        for(let c=0;c<LASER_COLS;c++){
          const cell=document.createElement('div');
          cell.className='laser-cell'; cell.dataset.r=r; cell.dataset.c=c;
          cell.addEventListener('click', onLaserClick);
          grid.appendChild(cell);
        }
      }
    }
    function onLaserClick(e){
      const r=+e.currentTarget.dataset.r, c=+e.currentTarget.dataset.c;
      if(r===LASER_CORRECT.row && c===LASER_CORRECT.col){
        document.getElementById('laser-feedback').textContent='✅ Laser grid bypassed. (Digit revealed: 0)';
        setCodeDigit(1, 0);
        // Transition then auto-advance to Transfer Bars
        showTransition('No alarms so far. Keep it quiet — he’s almost at the meet.', 2200, ()=>{
          document.getElementById('laser-module').classList.add('hidden');
          document.getElementById('transfer-module').classList.remove('hidden');
          initTransfer();
        });
      } else {
        document.getElementById('laser-feedback').textContent='❌ Incorrect tile. Try again.';
        document.getElementById('app').classList.add('shake');
        setTimeout(()=>document.getElementById('app').classList.remove('shake'),400);
      }
    }

    // ===== Transfer Bars (Top, Right, Back, Left) =====
    const ORDER=['Top','Right','Back','Left'];
    const TARGETS=[89,47,95,16];
    const TOL=3; // ±3%
    let tInterval=null, tPercent=0, tIdx=0, tSpeed=0.35; // slightly slower

    function initTransfer(){
      clearInterval(tInterval); tPercent=0; tIdx=0; document.getElementById('trace').style.display='none';
      document.getElementById('transfer-feedback').textContent='';
      document.getElementById('transfer-percent').textContent='0%';
      document.getElementById('transfer-bar-fill').style.width='0%';
      tInterval=setInterval(tTick, 40);
    }
    function tTick(){
      tPercent += tSpeed; if(tPercent>100) tPercent=0;
      document.getElementById('transfer-bar-fill').style.width = tPercent+'%';
      document.getElementById('transfer-percent').textContent = Math.floor(tPercent)+'%';
    }
    function abortTransfer(){
      const target = TARGETS[tIdx];
      const ok = Math.abs(tPercent - target) <= TOL;
      if(ok){
        tIdx++;
        if(tIdx>=ORDER.length){
          clearInterval(tInterval);
          document.getElementById('transfer-feedback').textContent='✅ Sequence complete. (Digit revealed: 2)';
          setCodeDigit(2, 2);
          // Final transition before next (placeholder for future camera module)
          showTransition('Override fragment stored. One more to go — Chris is nearing his stop.', 2400);
        } else {
          tPercent=0;
        }
      } else {
        document.getElementById('trace').style.display='block';
        document.getElementById('transfer-feedback').textContent='';
        document.getElementById('app').classList.add('shake');
        setTimeout(()=>{ document.getElementById('app').classList.remove('shake'); document.getElementById('trace').style.display='none'; }, 800);
        tIdx=0; tPercent=0;
      }
    }

    // ===== Events =====
    document.getElementById('abort-btn').addEventListener('click', abortTransfer);
  // === Add/override for camera module and adjusted transfer flow ===
const ORDER=['Top','Right','Back','Left'];
const TARGETS=[89,47,95,16];
const TOL=3;
let tInterval=null, tPercent=0, tIdx=0, tSpeed=0.35;
function initTransfer(){
  try{ clearInterval(tInterval);}catch(e){}
  tPercent=0; tIdx=0;
  const traceEl=document.getElementById('trace'); if(traceEl) traceEl.style.display='none';
  const tfb=document.getElementById('transfer-feedback'); if(tfb) tfb.textContent='';
  const tp=document.getElementById('transfer-percent'); if(tp) tp.textContent='0%';
  const fill=document.getElementById('transfer-bar-fill'); if(fill) fill.style.width='0%';
  tInterval=setInterval(()=>{
    tPercent += tSpeed; if(tPercent>100) tPercent=0;
    if(fill) fill.style.width=tPercent+'%';
    if(tp) tp.textContent=Math.floor(tPercent)+'%';
  },40);
}
function abortTransfer(){
  const target = TARGETS[tIdx];
  const ok = Math.abs(tPercent - target) <= TOL;
  if(ok){
    tIdx++;
    if(tIdx>=ORDER.length){
      clearInterval(tInterval);
      const tfb=document.getElementById('transfer-feedback'); if(tfb) tfb.textContent='✅ Sequence complete. (Digit revealed: 2)';
      setCodeDigit(2,2);
      showTransition('Traffic cams acquired. Pull the final code from the footage.', 2600, ()=>{
        document.getElementById('transfer-module')?.classList.add('hidden');
        document.getElementById('camera-module')?.classList.remove('hidden');
        initCamera();
      });
    } else {
      tPercent=0;
    }
  } else {
    const traceEl=document.getElementById('trace'); if(traceEl) traceEl.style.display='block';
    const tfb=document.getElementById('transfer-feedback'); if(tfb) tfb.textContent='';
    document.getElementById('app')?.classList.add('shake');
    setTimeout(()=>{ document.getElementById('app')?.classList.remove('shake'); if(traceEl) traceEl.style.display='none'; },800);
    tIdx=0; tPercent=0;
  }
}

const REQUIRED_CAM_CODE='1472';
const FINAL_DIGIT=6; // change this to set the last digit revealed
function initCamera(){
  const fb=document.getElementById('cam-feedback'); if(fb) fb.textContent='';
  const vid=document.getElementById('cam-video'); if(vid){ vid.currentTime=0; vid.play().catch(()=>{}); }
  const inp=document.getElementById('cam-code'); if(inp) inp.value='';
}
(document.getElementById('cam-submit')||{}).addEventListener?.('click', ()=>{
  const val=(document.getElementById('cam-code')?.value||'').trim();
  const fb=document.getElementById('cam-feedback');
  if(!/^\d{4}$/.test(val)){ if(fb) fb.textContent='Enter a 4‑digit code.'; return; }
  if(val===REQUIRED_CAM_CODE){
    setCodeDigit(3, FINAL_DIGIT);
    if(fb) fb.textContent=`✅ Correct. Final digit unlocked: ${FINAL_DIGIT}`;
    if(codeDigits?.every?.(d=>d!==null)){ showTransition(`Vault Code Complete: ${codeDigits.join(' ')}`, 2800); }
  } else {
    if(fb) fb.textContent='❌ Incorrect — check the footage again.';
    document.getElementById('app')?.classList.add('shake');
    setTimeout(()=>document.getElementById('app')?.classList.remove('shake'), 400);
  }
});
// === end camera additions ===
</script>
</body>
</html>
