<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heist Puzzle Box</title>
  <style>
    body { margin:0; font-family:'Courier New', monospace; background:#000; color:#0f0; overflow:hidden; }
    #matrix { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-2; }
    .hidden { display:none; }
    #app { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; padding:1em; }
    @keyframes shake { 0%,100%{transform:translate(0);}25%{transform:translate(2px);}50%{transform:translate(-2px);}75%{transform:translate(2px);} }
    .shake { animation:shake .5s; }
    .screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:1.5em; border-radius:8px; width:90%; max-width:400px; }
    .screen h1, .screen h2 { margin-bottom:0.5em; }
    .screen p { margin-bottom:1em; line-height:1.3; }
    .screen button { background:transparent; color:#0f0; border:1px solid #0f0; padding:0.5em 1em; cursor:pointer; margin:0.3em; user-select:none; -webkit-user-select:none; }
    #wire-container { display:flex; flex-direction:column; gap:0.5em; }
    .wire { display:flex; align-items:center; gap:0.5em; }
    .wire .label { flex:1; text-align:left; }
    .wire-graphic { flex:2; font-family:'Courier New', monospace; text-align:center; }
    #code-panel { position:fixed; bottom:8px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); border:1px solid #0f0; border-radius:6px; padding:6px 10px; font-size:1rem; z-index:2; }
    #code-digits { letter-spacing:.3em; font-weight:bold; }
    #laser-grid { display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(5,1fr); gap:4px; margin-top:1em; }
    .laser-cell { width:50px; height:50px; border:1px solid #0f0; cursor:pointer; }
      #transfer-module { background:rgba(0,0,0,0.9); padding:1.2em; border-radius:8px; width:90%; max-width:420px; }
    #transfer-title { color:#0f0; font-weight:bold; margin-bottom:.25em; }
    #transfer-context { color:#0f0; font-size:.95em; margin-bottom:.75em; }
    #transfer-target { margin:.25em 0 .75em; color:#0f0; }
    #transfer-bar { width:100%; height:14px; border:1px solid #0f0; border-radius:6px; position:relative; overflow:hidden; background:rgba(0,255,0,0.05); }
    #transfer-bar-fill { position:absolute; left:0; top:0; height:100%; width:0%; background:#0f0; }
    #transfer-percent { margin-top:.4em; }
    #trace { color:#f33; font-weight:bold; margin:.6em 0; display:none; }
    #transfer-controls button { margin-top:10px; }
  </style>
</head>
<body>
  <audio id="bg-music" src="./Radional.mp3" loop preload="auto"></audio>
  <canvas id="matrix"></canvas>
  <div id="app">
    <div id="start-screen" class="screen">
      <h1>Heist Protocol: A Puzzle Box</h1>
      <p><strong>Backstory:</strong> You're hacking a bank safe.</p>
      <button id="start-btn">Start!</button>
    </div>

    <div id="wire-module" class="screen hidden">
      <h2>Module: Wire Control</h2>
      <p id="manual-note">Refer to printed wire instructions.</p>
      <div id="serial"></div>
      <div id="wire-container"></div>
      <p id="feedback"></p>
      <button id="next-btn" class="hidden">Next Module</button>
    </div>

    <div id="laser-module" class="screen hidden">
      <h2>Module: Laser System</h2>
      <img src="./LaserDevice.png" alt="Laser Grid" style="width:100%;max-width:300px;border:1px solid #0f0;"/>
      <div id="laser-grid"></div>
      <p id="laser-feedback"></p>
      <button id="laser-next-btn" class="hidden">Next Module</button>
    </div>

    <div id="transfer-module" class="screen hidden">
      <h2>Module: Transfer Bars</h2>
      <div id="transfer-title">Transferring Encrypted Files…</div>
      <div id="transfer-context">Follow the safe clue order and abort at the right moment.</div>
      <div id="transfer-target"></div>
      <div id="transfer-bar"><div id="transfer-bar-fill"></div></div>
      <div id="transfer-percent">0%</div>
      <div id="trace">TRACE INITIATED!</div>
      <div id="transfer-controls"><button id="abort-btn">ABORT TRANSFER</button></div>
      <p id="transfer-feedback"></p>
      <button id="transfer-back-btn" class="hidden">Back to Start</button>
    </div>

    <div id="code-panel" class="hidden">Vault Code: <span id="code-digits">_ _ _ _</span></div>
  </div>

  <script>
    const canvas = document.getElementById('matrix'), ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const cols = Math.floor(canvas.width/20)+1, ypos = Array(cols).fill(0);
    setInterval(() => {
      ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#0f0'; ctx.font = '16px Courier New';
      ypos.forEach((y,i) => { ctx.fillText(Math.random()>0.5?'1':'0', i*20, y); ypos[i] = y > canvas.height ? 0 : y + 20; });
    },50);

    const codeDigits = [null, null, null, null];
    function renderCodePanel(){
      const panel = document.getElementById('code-panel');
      const s = codeDigits.map(d => d===null ? '_' : d).join(' ');
      document.getElementById('code-digits').textContent = s;
      panel.classList.remove('hidden');
    }

    function setCodeDigit(pos, val){
      if(codeDigits[pos]===null){
        codeDigits[pos] = val;
        renderCodePanel();
      }
    }

    let wires = [], serialNumber = '', lastDigitOdd = false;
    function randomizeWires() {
      serialNumber = String(Math.floor(Math.random()*1e6)).padStart(6,'0');
      lastDigitOdd = parseInt(serialNumber.slice(-1)) % 2 === 1;
      document.getElementById('serial').textContent = `SN: ${serialNumber}`;
      const colors = ['red','white','blue','yellow','black'];
      wires = Array.from({length:3+Math.floor(Math.random()*4)}, () => colors[Math.floor(Math.random()*colors.length)]);
    }
    function getCorrectWire() {
      const cnt = c => wires.filter(w=>w===c).length, l = wires.length;
      if(l===3){ if(cnt('red')===0) return 1; if(wires[2]==='white') return 2; if(cnt('blue')>1) return wires.lastIndexOf('blue'); return 2; }
      if(l===4){ if(cnt('red')>1&&lastDigitOdd) return wires.lastIndexOf('red'); if(wires[3]==='yellow'&&cnt('red')===0) return 0; if(cnt('blue')===1) return 0; if(cnt('yellow')>1) return 3; return 1; }
      if(l===5){ if(wires[4]==='black'&&lastDigitOdd) return 3; if(cnt('red')===1&&cnt('yellow')>1) return 0; if(cnt('black')===0) return 1; return 0; }
      if(l===6){ if(cnt('yellow')===0&&lastDigitOdd) return 2; if(cnt('yellow')===1&&cnt('white')>1) return 3; if(cnt('red')===0) return 5; return 3; }
      return 0;
    }

    function initWires() {
      randomizeWires();
      document.getElementById('feedback').textContent = '';
      const ctr = document.getElementById('wire-container'); ctr.innerHTML = '';
      wires.forEach((col,i) => {
        const dashes = '─'.repeat(20);
        const div = document.createElement('div'); div.className = 'wire';
        div.innerHTML = `<span class="label">Wire ${i+1} (${col})</span><span id="wire-graphic-${i}" class="wire-graphic" style="color:${col};">${dashes}</span><button class="cut-button" data-i="${i}">Cut</button>`;
        ctr.appendChild(div);
      });
      document.querySelectorAll('.cut-button').forEach(b=>b.addEventListener('click', handleCut));
    }

    function handleCut(e) {
      const idx = +e.target.dataset.i, correct = getCorrectWire();
      const gr = document.getElementById(`wire-graphic-${idx}`);
      if(gr){ const t = gr.textContent, m = Math.floor(t.length/2); gr.textContent = t.slice(0,m)+'  '+t.slice(m+2); }
      if(idx===correct){ document.getElementById('feedback').textContent='✅ Disarmed. Digit revealed: 8'; setCodeDigit(0,8); document.getElementById('next-btn').classList.remove('hidden'); }
      else { document.getElementById('feedback').textContent='❌ Wrong wire.'; document.getElementById('app').classList.add('shake'); setTimeout(()=>document.getElementById('app').classList.remove('shake'),500); }
    }

    function initLaser(){
      const grid=document.getElementById('laser-grid'); grid.innerHTML='';
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const cell=document.createElement('div');
          cell.className='laser-cell';
          cell.dataset.row=r; cell.dataset.col=c;
          cell.addEventListener('click',()=>{
            if(r===4&&c===2){ document.getElementById('laser-feedback').textContent='✅ Correct! Digit revealed: 0'; setCodeDigit(1,0); document.getElementById('laser-next-btn').classList.remove('hidden'); }
            else { document.getElementById('laser-feedback').textContent='❌ Wrong square!'; document.getElementById('app').classList.add('shake'); setTimeout(()=>document.getElementById('app').classList.remove('shake'),500); }
          });
          grid.appendChild(cell);
        }
      }
    }

    document.getElementById('start-btn').addEventListener('click',()=>{
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('wire-module').classList.remove('hidden');
      renderCodePanel(); initWires();
      const bg = document.getElementById('bg-music'); bg.play().catch(e=>console.warn('Audio play failed:',e));
    });

    document.getElementById('next-btn').addEventListener('click',()=>{
      document.getElementById('wire-module').classList.add('hidden');
      document.getElementById('laser-module').classList.remove('hidden');
      initLaser();
    });

    // === Transfer Bars logic ===
    const ORDER=['Top','Right','Back','Left'];
    const TARGETS=[89,47,95,16];
    const TOL=3; // ±3%
    let tInterval=null, tPercent=0, tIdx=0, tSpeed=0.6; // ~5s per cycle

    function initTransfer(){
      clearInterval(tInterval); tPercent=0; tIdx=0; document.getElementById('trace').style.display='none';
      updateTransferUI();
      tInterval=setInterval(tTick, 30);
      document.getElementById('transfer-feedback').textContent='';
      document.getElementById('transfer-back-btn').classList.add('hidden');
      document.getElementById('transfer-percent').textContent='0%';
      document.getElementById('transfer-bar-fill').style.width='0%';
    }
    function tTick(){
      tPercent += tSpeed; if(tPercent>100) tPercent=0;
      document.getElementById('transfer-bar-fill').style.width = tPercent+'%';
      document.getElementById('transfer-percent').textContent = Math.floor(tPercent)+'%';
    }
    function updateTransferUI(){
      document.getElementById('transfer-target').textContent = `Target ${ORDER[tIdx]}: abort near ${TARGETS[tIdx]}% (±${TOL}%)`;
    }
    function abortTransfer(){
      const target = TARGETS[tIdx];
      const ok = Math.abs(tPercent - target) <= TOL;
      if(ok){
        tIdx++;
        if(tIdx>=ORDER.length){
          clearInterval(tInterval);
          document.getElementById('transfer-feedback').textContent='✅ Sequence complete.';
          document.getElementById('transfer-back-btn').classList.remove('hidden');
        } else {
          tPercent=0; updateTransferUI();
          document.getElementById('transfer-feedback').textContent='✔ Next: '+ORDER[tIdx];
        }
      } else {
        document.getElementById('trace').style.display='block';
        document.getElementById('transfer-feedback').textContent='❌ TRACE INITIATED! Sequence reset to Top.';
        document.getElementById('app').classList.add('shake');
        setTimeout(()=>{ document.getElementById('app').classList.remove('shake'); document.getElementById('trace').style.display='none'; }, 700);
        tIdx=0; tPercent=0; updateTransferUI();
      }
    }

    document.getElementById('laser-next-btn').addEventListener('click',()=>{
      document.getElementById('laser-module').classList.add('hidden');
      document.getElementById('transfer-module').classList.remove('hidden');
      initTransfer();
    });
    document.getElementById('abort-btn').addEventListener('click', abortTransfer);
    document.getElementById('transfer-back-btn').addEventListener('click',()=>{
      document.getElementById('transfer-module').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    });
  </script>
</body>
</html>
