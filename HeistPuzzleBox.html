<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heist Puzzle Box</title>
  <style>
    body { margin:0; font-family:'Courier New', monospace; background:#000; color:#0f0; overflow:hidden; }
    #matrix { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-2; }
    .hidden { display:none; }
    #app { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; padding:1em; }
    @keyframes shake { 0%,100%{transform:translate(0);}25%{transform:translate(2px);}50%{transform:translate(-2px);}75%{transform:translate(2px);} }
    .shake { animation:shake .5s; }
    #status-bar { position:absolute; top:1em; right:1em; font-size:1.2em; }
    #timer { padding:0.2em 0.5em; border:1px solid #0f0; border-radius:4px; }
    .screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:1.5em; border-radius:8px; width:90%; max-width:400px; }
    .screen h1, .screen h2 { margin-bottom:0.5em; }
    .screen p { margin-bottom:1em; line-height:1.3; }
    .screen button { background:transparent; color:#0f0; border:1px solid #0f0; padding:0.5em 1em; cursor:pointer; margin:0.3em; user-select:none; -webkit-user-select:none; } user-select:none; -webkit-user-select:none; } user-select:none; -webkit-user-select:none; }
    #wire-module, #memory-module, #letter-module, #button-module, #password-module { background:rgba(0,0,0,0.8); padding:1em; border-radius:8px; width:90%; max-width:400px; }
    #manual-note { font-size:0.9em; margin-bottom:1em; border:1px dashed #0f0; padding:0.5em; }
    #serial, #memory-display, #letter-display { font-size:1.2em; margin-bottom:1em; }
    #wire-container { display:flex; flex-direction:column; gap:0.5em; }
    .wire { display:flex; align-items:center; gap:0.5em; }
    .wire .label { flex:1; text-align:left; }
    .wire-graphic { flex:2; font-family:'Courier New', monospace; text-align:center; }
    .next-btn { margin-top:1em; }
    button, .cut-button, .letter-btn, .pass-up, .pass-down, #release-btn { margin-top:1em; }
    .pass-letter { display:flex; flex-direction:column; align-items:center; }
  </style>
</head>
<body>
  <audio id="bg-music" src="Radional.mp3" loop preload="auto"></audio>  <!-- background music -->
  <canvas id="matrix"></canvas>
  <div id="app">
    <div id="status-bar" class="hidden"><div id="timer">10:00</div></div>
    <div id="start-screen" class="screen">
      <h1>Heist Protocol: A Puzzle Box</h1>
      <p><strong>Backstory:</strong> You're hacking a bank safe. You have <strong>10 minutes</strong>.</p>
      <p></p>
      <p style="font-size:0.9em;">We recommend watching the instructions before starting.</p>
      <p style="font-size:0.9em;">We recommend watching the instructions before starting.</p>
      <button id="instructions-btn">Instructions</button>
      <button id="start-btn">Start!</button>
    </div>

    <div id="wire-module" class="screen hidden">
      <h2>Module: Wire Control</h2>
      <p id="manual-note">Refer to printed wire instructions.</p>
      <div id="serial"></div>
      <div id="wire-container"></div>
      <p id="feedback"></p>
      <button id="wire-next" class="next-btn hidden">Next Module</button>
    </div>

    <div id="memory-module" class="screen hidden">
      <h2>Module: Memory</h2>
      <div id="memory-display">1</div>
      <div id="memory-buttons"></div>
      <p id="memory-feedback"></p>
      <button id="mem-next" class="next-btn hidden">Next Module</button>
    </div>

    <div id="letter-module" class="screen hidden">
      <h2>Module: Letter Keys</h2>
      <div id="info-panel-letter" style="font-size:0.9em;margin-bottom:0.5em;"></div>
      <div id="letter-display">00</div>
      <div id="letter-grid">
        <button class="letter-btn" data-l="A">A</button>
        <button class="letter-btn" data-l="B">B</button>
        <button class="letter-btn" data-l="C">C</button>
        <button class="letter-btn" data-l="D">D</button>
      </div>
      <p id="letter-feedback"></p>
      <button id="letter-next" class="next-btn hidden">Next Module</button>
    </div>

    <div id="button-module" class="screen hidden">
      <h2>Module: The Button</h2>
      <div id="info-panel-button" style="font-size:0.9em;margin-bottom:0.5em;"></div>
      <button id="the-button" style="padding:1em 2em;">TEXT</button>
      <div id="strip-ui" class="hidden"><p>Strip Color: <span id="strip-color"></span></p><button id="release-btn">Release</button></div>
      <p id="button-feedback"></p>
      <button id="button-next" class="next-btn hidden">Next Module</button>
    </div>

    <div id="password-module" class="screen hidden">
      <h2>Module: Password</h2>
      <div style="display:flex;gap:1em;justify-content:center;">
        <!-- wheels -->
        <div class="pass-letter"><button class="pass-up" data-i="0">▲</button><div id="pass-char-0">H</div><button class="pass-down" data-i="0">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="1">▲</button><div id="pass-char-1">O</div><button class="pass-down" data-i="1">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="2">▲</button><div id="pass-char-2">U</div><button class="pass-down" data-i="2">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="3">▲</button><div id="pass-char-3">S</div><button class="pass-down" data-i="3">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="4">▲</button><div id="pass-char-4">E</div><button class="pass-down" data-i="4">▼</button></div>
      </div>
      <button id="pass-submit">Submit</button>
      <p id="pass-feedback"></p>
    </div>

    <div id="game-over" class="screen hidden">
      <h2>Safe Locked</h2>
      <p>Enjoy your time in prison.</p>
      <button id="restart-btn">Restart</button>
    </div>
  </div>

  <script>
    // Matrix rain omitted for brevity
    // Timer & Penalty omitted for brevity

    // Shuffle modules order
    const moduleOrder = ['wire-module','memory-module','letter-module','button-module','password-module'];
    let modIndex = 0;
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    function showModule(idx) {
      // hide all
      moduleOrder.forEach(id => document.getElementById(id).classList.add('hidden'));
      // show specific
      document.getElementById(moduleOrder[idx]).classList.remove('hidden');
    }

    // Wire Control functions (initWires, getCorrectWire, handleCut) unchanged
    // Memory functions (initMemory, renderMem, pressMem) unchanged
    // Letter functions (initLetter, letter-btn handlers) unchanged
    // Button functions (initButton, handlePress) unchanged
    // Password functions (initPassword, pass-submit handler) unchanged

    // Navigation
    document.getElementById('instructions-btn').addEventListener('click', () => window.open('https://youtube.com/shorts/9tSo2e8ZHdI','_blank'));
    document.getElementById('start-btn').addEventListener('click',()=>{
      // play background music
      const bg = document.getElementById('bg-music');
      bg.play().catch(e=>console.warn('Audio play failed:',e));
      shuffle(moduleOrder);
      document.getElementById('start-screen').classList.add('hidden');
      modIndex = 0;
      startTimer();
      showModule(modIndex);
      // initialize first module
      initWires();
    });
    // Next button unified
    document.querySelectorAll('.next-btn').forEach(btn => btn.addEventListener('click', () => {
      modIndex++;
      if (modIndex < moduleOrder.length) {
        showModule(modIndex);
        // call init for each module
        const id = moduleOrder[modIndex];
        if (id === 'wire-module') initWires();
        if (id === 'memory-module') initMemory();
        if (id === 'letter-module') initLetter();
        if (id === 'button-module') initButton();
        if (id === 'password-module') initPassword();
      }
    }));
    document.getElementById('restart-btn').addEventListener('click', () => location.reload());
  </script>
</body>
</html>
