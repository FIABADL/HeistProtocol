<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heist Puzzle Box</title>
  <style>
    body { margin:0; font-family:'Courier New', monospace; background:#000; color:#0f0; overflow:hidden; }
    #matrix { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:-2; }
    .hidden { display:none; }
    #app { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; padding:1em; }
    @keyframes shake { 0%,100%{transform:translate(0);}25%{transform:translate(2px);}50%{transform:translate(-2px);}75%{transform:translate(2px);} }
    .shake { animation:shake .5s; }
    #status-bar { position:absolute; top:1em; right:1em; font-size:1.2em; }
    #timer { padding:0.2em 0.5em; border:1px solid #0f0; border-radius:4px; }
    .screen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:1.5em; border-radius:8px; width:90%; max-width:400px; }
    .screen h1, .screen h2 { margin-bottom:0.5em; }
    .screen p { margin-bottom:1em; line-height:1.3; }
    .screen button { background:transparent; color:#0f0; border:1px solid #0f0; padding:0.5em 1em; cursor:pointer; margin:0.3em; user-select:none; -webkit-user-select:none; } }
    #wire-module, #memory-module, #letter-module, #button-module, #password-module { background:rgba(0,0,0,0.8); padding:1em; border-radius:8px; width:90%; max-width:400px; }
    #manual-note { font-size:0.9em; margin-bottom:1em; border:1px dashed #0f0; padding:0.5em; }
    #serial, #memory-display, #letter-display { font-size:1.2em; margin-bottom:1em; }
    #wire-container { display:flex; flex-direction:column; gap:0.5em; }
    .wire { display:flex; align-items:center; gap:0.5em; }
    .wire .label { flex:1; text-align:left; }
    .wire-graphic { flex:2; font-family:'Courier New', monospace; text-align:center; }
    button, .cut-button, .letter-btn, .pass-up, .pass-down, #release-btn { margin-top:1em; }
    .pass-letter { display:flex; flex-direction:column; align-items:center; }
  </style>
</head>
<body>
  <audio id="bg-music" src="./Radional.mp3" loop preload="auto" controls></audio> <!-- background music -->
  <canvas id="matrix"></canvas>
  <div id="app">
    <div id="status-bar" class="hidden"><div id="timer">10:00</div></div>
    <div id="start-screen" class="screen">
      <h1>Heist Protocol: A Puzzle Box</h1>
      <p><strong>Backstory:</strong> You're hacking a bank safe. You have <strong>10 minutes</strong>.</p>
      <p></p>
      <p style="font-size:0.9em;">We recommend watching the instructions before starting.</p>
      <button id="instructions-btn">Instructions</button>
      <button id="start-btn">Start!</button>
    </div>

    <div id="wire-module" class="screen hidden">
      <h2>Module: Wire Control</h2>
      <p id="manual-note">Refer to printed wire instructions.</p>
      <div id="serial"></div>
      <div id="wire-container"></div>
      <p id="feedback"></p>
      <button id="next-btn" class="hidden">Next Module</button>
    </div>

    <div id="memory-module" class="screen hidden">
      <h2>Module: Memory</h2>
      <div id="memory-display">1</div>
      <div id="memory-buttons"></div>
      <p id="memory-feedback"></p>
      <button id="memory-next-btn" class="hidden">Next Module</button>
    </div>

    <div id="letter-module" class="screen hidden">
      <h2>Module: Letter Keys</h2>
      <div id="info-panel-letter" style="font-size:0.9em;margin-bottom:0.5em;"></div>
      <div id="letter-display">00</div>
      <div id="letter-grid">
        <button class="letter-btn" data-l="A">A</button>
        <button class="letter-btn" data-l="B">B</button>
        <button class="letter-btn" data-l="C">C</button>
        <button class="letter-btn" data-l="D">D</button>
      </div>
      <p id="letter-feedback"></p>
      <button id="letter-next-btn" class="hidden">Next Module</button>
    </div>

    <div id="button-module" class="screen hidden">
      <h2>Module: The Button</h2>
      <div id="info-panel-button" style="font-size:0.9em;margin-bottom:0.5em;"></div>
      <button id="the-button" style="padding:1em 2em;">TEXT</button>
      <div id="strip-ui" class="hidden"><p>Strip Color: <span id="strip-color"></span></p><button id="release-btn">Release</button></div>
      <p id="button-feedback"></p>
      <button id="button-next-btn" class="hidden">Next Module</button>
    </div>

    <div id="password-module" class="screen hidden">
      <h2>Module: Password</h2>
      <div style="display:flex;gap:1em;justify-content:center;">
        <div class="pass-letter"><button class="pass-up" data-i="0">▲</button><div id="pass-char-0">H</div><button class="pass-down" data-i="0">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="1">▲</button><div id="pass-char-1">O</div><button class="pass-down" data-i="1">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="2">▲</button><div id="pass-char-2">U</div><button class="pass-down" data-i="2">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="3">▲</button><div id="pass-char-3">S</div><button class="pass-down" data-i="3">▼</button></div>
        <div class="pass-letter"><button class="pass-up" data-i="4">▲</button><div id="pass-char-4">E</div><button class="pass-down" data-i="4">▼</button></div>
      </div>
      <button id="pass-submit">Submit</button>
      <p id="pass-feedback"></p>
    </div>

    <div id="game-over" class="screen hidden">
      <h2>Safe Locked</h2>
      <p>Enjoy your time in prison.</p>
      <button id="restart-btn">Restart</button>
    </div>
  </div>

  <script>
    // Matrix rain
    const canvas = document.getElementById('matrix'), ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const cols = Math.floor(canvas.width/20)+1, ypos = Array(cols).fill(0);
    setInterval(() => {
      ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#0f0'; ctx.font = '16px Courier New';
      ypos.forEach((y,i) => { ctx.fillText(Math.random()>0.5?'1':'0', i*20, y); ypos[i] = y > canvas.height ? 0 : y + 20; });
    },50);

    // Timer & penalties
    let totalTime = 600, timerInt, strikeCount = 0;
    function startTimer() {
      document.getElementById('status-bar').classList.remove('hidden');
      timerInt = setInterval(() => {
        totalTime--;
        if (totalTime < 0) { clearInterval(timerInt); gameOver(); return; }
        document.getElementById('timer').textContent = `${String(Math.floor(totalTime/60)).padStart(2,'0')}:${String(totalTime%60).padStart(2,'0')}`;
      },1000);
    }
    function applyPenalty() {
      strikeCount++;
      totalTime = Math.max(0, totalTime - strikeCount*5);
      document.getElementById('timer').textContent = `${String(Math.floor(totalTime/60)).padStart(2,'0')}:${String(totalTime%60).padStart(2,'0')}`;
      if (totalTime === 0) gameOver();
    }
    function gameOver() {
      // stop background music
      const bg = document.getElementById('bg-music'); bg.pause(); bg.currentTime = 0;
      clearInterval(timerInt);
      ['start-screen','wire-module','memory-module','letter-module','button-module','password-module','status-bar']
        .forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('game-over').classList.remove('hidden');
    }

    // Module 1: Wire Control
    let wires = [], serialNumber = '', lastDigitOdd = false;
    function randomizeWires() {
      serialNumber = String(Math.floor(Math.random()*1e6)).padStart(6,'0');
      lastDigitOdd = parseInt(serialNumber.slice(-1)) % 2 === 1;
      document.getElementById('serial').textContent = `SN: ${serialNumber}`;
      const colors = ['red','white','blue','yellow','black'];
      wires = Array.from({length:3+Math.floor(Math.random()*4)}, () => colors[Math.floor(Math.random()*colors.length)]);
    }
    function getCorrectWire() {
      const cnt = c => wires.filter(w=>w===c).length, l = wires.length;
      if(l===3){ if(cnt('red')===0) return 1; if(wires[2]==='white') return 2; if(cnt('blue')>1) return wires.lastIndexOf('blue'); return 2; }
      if(l===4){ if(cnt('red')>1&&lastDigitOdd) return wires.lastIndexOf('red'); if(wires[3]==='yellow'&&cnt('red')===0) return 0; if(cnt('blue')===1) return 0; if(cnt('yellow')>1) return 3; return 1; }
      if(l===5){ if(wires[4]==='black'&&lastDigitOdd) return 3; if(cnt('red')===1&&cnt('yellow')>1) return 0; if(cnt('black')===0) return 1; return 0; }
      if(l===6){ if(cnt('yellow')===0&&lastDigitOdd) return 2; if(cnt('yellow')===1&&cnt('white')>1) return 3; if(cnt('red')===0) return 5; return 3; }
      return 0;
    }
    function initWires() {
      randomizeWires();
      document.getElementById('feedback').textContent = '';
      const ctr = document.getElementById('wire-container'); ctr.innerHTML = '';
      wires.forEach((col,i) => {
        const dashes = '─'.repeat(20);
        const div = document.createElement('div'); div.className = 'wire';
        div.innerHTML = `<span class="label">Wire ${i+1} (${col})</span><span id="wire-graphic-${i}" class="wire-graphic" style="color:${col};">${dashes}</span><button class="cut-button" data-i="${i}">Cut</button>`;
        ctr.appendChild(div);
      });
      document.querySelectorAll('.cut-button').forEach(b=>b.addEventListener('click', handleCut));
    }
    function handleCut(e) {
      const idx = +e.target.dataset.i, correct = getCorrectWire();
      const gr = document.getElementById(`wire-graphic-${idx}`);
      if(gr){ const t = gr.textContent, m = Math.floor(t.length/2); gr.textContent = t.slice(0,m)+'  '+t.slice(m+2); }
      if(idx===correct){ document.getElementById('feedback').textContent='✅ Disarmed.'; document.getElementById('next-btn').classList.remove('hidden'); }
      else { applyPenalty(); document.getElementById('feedback').textContent=`❌ Wrong! -${strikeCount*5}s`; document.getElementById('app').classList.add('shake'); setTimeout(()=>document.getElementById('app').classList.remove('shake'),500); }
    }

    // Module 2: Memory
    let memStage=1, hist={positions:{},labels:{}};
    function initMemory(){ memStage=1; hist={positions:{},labels:{}}; renderMem(); }
    function renderMem(){ const d=Math.ceil(Math.random()*4); document.getElementById('memory-display').textContent=d; document.getElementById('memory-feedback').textContent=`Stage ${memStage}`; const btns=document.getElementById('memory-buttons'); btns.innerHTML=''; ['1','2','3','4'].sort(()=>Math.random()-0.5).forEach((l,i)=>{ const b=document.createElement('button'); b.textContent=l; b.dataset.pos=i+1; b.dataset.lbl=l; b.addEventListener('click',()=>pressMem(d,i+1,l)); btns.appendChild(b); }); document.getElementById('memory-next-btn').classList.add('hidden'); }
    function pressMem(d,p,l){ let cp, cl; switch(memStage){ case 1: cp=d<=2?2:d===3?3:4; break; case 2: if(d===1) cl='4'; else if(d===2) cp=hist.positions[1]; else if(d===3) cp=1; else cp=hist.positions[1]; break; case 3: if(d===1) cl=hist.labels[2]; else if(d===2) cl=hist.labels[1]; else if(d===3) cp=3; else cl='4'; break; case 4: if(d===1) cp=hist.positions[1]; else if(d===2) cp=1; else if(d===3) cp=hist.positions[2]; else cp=hist.positions[2]; break; case 5: if(d===1) cl=hist.labels[1]; else if(d===2) cl=hist.labels[2]; else if(d===3) cl=hist.labels[4]; else cl=hist.labels[3]; break; } const ok = cp!==undefined ? (p===cp) : (l===cl); if(!ok){ applyPenalty(); document.getElementById('memory-feedback').textContent='❌ Reset'; memStage=1; setTimeout(renderMem,1000); return; } hist.positions[memStage]=p; hist.labels[memStage]=l; if(memStage<5){ memStage++; setTimeout(renderMem,500); } else { document.getElementById('memory-feedback').textContent='✅ Complete'; document.getElementById('memory-next-btn').classList.remove('hidden'); } }

    // Module 3: Letter Keys
    let letterNum=0, batteryCount=0, serial='';
    function initLetter(){ letterNum=Math.floor(Math.random()*100); document.getElementById('letter-display').textContent=String(letterNum).padStart(2,'0'); batteryCount=Math.floor(Math.random()*5); serial=Array.from({length:6},()=>'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random()*36)]).join(''); document.getElementById('info-panel-letter').innerHTML=`<p>Serial: ${serial}</p><p>Batteries: ${batteryCount}</p>`; document.getElementById('letter-feedback').textContent=''; document.getElementById('letter-next-btn').classList.add('hidden'); }
    document.querySelectorAll('.letter-btn').forEach(b=>b.addEventListener('click',()=>{ const l=b.dataset.l; let correct; if(letterNum===69) correct=l==='D'; else if(letterNum%6===0) correct=l==='A'; else if(batteryCount>=2&&letterNum%3===0) correct=l==='B'; else if(/[CE3]/.test(serial)&&letterNum>=22&&letterNum<=79) correct=l==='B'; else if(/[CE3]/.test(serial)) correct=l==='C'; else if(letterNum<46) correct=l==='D'; else correct=l==='A'; if(correct){ document.getElementById('letter-feedback').textContent='✅ Correct'; document.getElementById('letter-next-btn').classList.remove('hidden'); } else { applyPenalty(); document.getElementById('letter-feedback').textContent='❌ Reset'; setTimeout(initLetter,1000); } }));

    // Module 4: The Button
    let btnColor='', btnText='', batteryCountB=0, litInds=[]; let holdTimer, held=false;
    function initButton(){ const colors=['blue','white','yellow','red'], texts=['Abort','Detonate','Hold']; btnColor=colors[Math.floor(Math.random()*colors.length)]; btnText=texts[Math.floor(Math.random()*texts.length)]; const btn=document.getElementById('the-button'); btn.style.background=btnColor; btn.textContent=btnText; batteryCountB=Math.floor(Math.random()*6); const inds=['SND','CLR','CAR','IND','FRQ','SIG','NSA','MSA','TRN','BOB','FRK']; litInds=inds.sort(()=>Math.random()-0.5).slice(0,Math.floor(Math.random()*4)); document.getElementById('info-panel-button').innerHTML=`<p>Batteries: ${batteryCountB}</p><p>Lit Indicators: ${litInds.length?litInds.join(', '):'None'}</p>`; document.getElementById('strip-ui').classList.add('hidden'); document.getElementById('button-feedback').textContent=''; held=false; }
    document.getElementById('the-button').addEventListener('mousedown',()=>{ holdTimer=setTimeout(()=>{ held=true; document.getElementById('strip-ui').classList.remove('hidden'); document.getElementById('release-btn').classList.remove('hidden'); },500); });
    document.getElementById('the-button').addEventListener('mouseup',()=>{ clearTimeout(holdTimer); if(!held) handlePress(); });
    function handlePress(){ let correct=false; if(btnColor==='blue'&&btnText==='Abort') correct=false; else if(batteryCountB>1&&btnText==='Detonate') correct=true; else if(btnColor==='white'&&litInds.includes('CAR')) correct=false; else if(batteryCountB>2&&litInds.includes('FRK')) correct=true; else if(btnColor==='yellow') correct=false; else if(btnColor==='red'&&btnText==='Hold') correct=true; if(correct){ document.getElementById('button-feedback').textContent='✅ Disarmed.'; document.getElementById('button-next-btn').classList.remove('hidden'); } else { applyPenalty(); document.getElementById('button-feedback').textContent='❌ Resetting.'; setTimeout(initButton,1000); } }
    document.getElementById('release-btn').addEventListener('click',()=>{ const time=document.getElementById('timer').textContent, color=document.getElementById('strip-color').textContent; let req; if(color==='blue') req='4'; else if(color==='white') req='1'; else if(color==='yellow') req='5'; else req='1'; if(time.includes(req)){ document.getElementById('button-feedback').textContent='✅ Disarmed.'; document.getElementById('button-next-btn').classList.remove('hidden'); } else { applyPenalty(); document.getElementById('button-feedback').textContent='❌ Wrong. Reset.'; setTimeout(initButton,1000); } });

    // Module 5: Password
    const correctWord='HOUSE'; const disallowed=['ABOUT','AFTER','AGAIN','BELOW','COULD','EVERY','FIRST','FOUND','GREAT','LARGE','LEARN','NEVER','OTHER','PLACE','PLANT','POINT','RIGHT','SMALL','SOUND','SPELL','STILL','STUDY','THEIR','THERE','THESE','THING','THINK','THREE','WATER','WHERE','WHICH','WORLD','WOULD','WRITE']; let allowedLetters=[], curIndex=[], passLetters=[];
    function initPassword(){ const alpha='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''); while(true){ allowedLetters=[]; for(let i=0;i<5;i++){ const set=new Set([correctWord[i]]); while(set.size<5){ const rand=alpha[Math.floor(Math.random()*alpha.length)]; if(rand!==correctWord[i]) set.add(rand);} allowedLetters[i]=Array.from(set);} let valid=true; for(const w of disallowed){ let canForm=true; for(let i=0;i<5;i++){ if(!allowedLetters[i].includes(w[i])){ canForm=false; break; }} if(canForm){ valid=false; break; }} if(valid) break;} curIndex=[]; passLetters=[]; for(let i=0;i<5;i++){ const arr=allowedLetters[i]; const rI=Math.floor(Math.random()*arr.length); curIndex[i]=rI; passLetters[i]=arr[rI]; } for(let i=0;i<5;i++){ document.getElementById(`pass-char-${i}`).textContent=passLetters[i]; } document.getElementById('pass-feedback').textContent=''; }
    document.querySelectorAll('.pass-up').forEach(btn=>btn.addEventListener('click',()=>{ const i=+btn.dataset.i; curIndex[i]=(curIndex[i]+1)%allowedLetters[i].length; passLetters[i]=allowedLetters[i][curIndex[i]]; document.getElementById(`pass-char-${i}`).textContent=passLetters[i]; }));
    document.querySelectorAll('.pass-down').forEach(btn=>btn.addEventListener('click',()=>{ const i=+btn.dataset.i; curIndex[i]=(curIndex[i]-1+allowedLetters[i].length)%allowedLetters[i].length; passLetters[i]=allowedLetters[i][curIndex[i]]; document.getElementById(`pass-char-${i}`).textContent=passLetters[i]; }));
    document.getElementById('pass-submit').addEventListener('click',()=>{ const word=passLetters.join(''); if(word===correctWord){ clearInterval(timerInt); document.getElementById('pass-feedback').textContent='All security systems deactivated.'; setTimeout(()=>{ document.getElementById('pass-feedback').textContent=`${correctWord} is the code for the safe.`; },1000); } else { applyPenalty(); document.getElementById('pass-feedback').textContent=`❌ Try again. -${strikeCount*5}s`; } });

    // Navigation
    document.getElementById('instructions-btn').addEventListener('click',()=>window.open('https://youtu.be/-1dn5n1JsX4?si=h6lz7WZFHlDEZLo-','_blank'));
    document.getElementById('start-btn').addEventListener('click',()=>{
      // play background music
      const bg = document.getElementById('bg-music');
      bg.play().catch(e=>console.warn('Audio play failed:',e)); document.getElementById('start-screen').classList.add('hidden'); document.getElementById('wire-module').classList.remove('hidden'); initWires(); startTimer(); });
    document.getElementById('next-btn').addEventListener('click',()=>{ document.getElementById('wire-module').classList.add('hidden'); document.getElementById('memory-module').classList.remove('hidden'); initMemory(); });
    document.getElementById('memory-next-btn').addEventListener('click',()=>{ document.getElementById('memory-module').classList.add('hidden'); document.getElementById('letter-module').classList.remove('hidden'); initLetter(); });
    document.getElementById('letter-next-btn').addEventListener('click',()=>{ document.getElementById('letter-module').classList.add('hidden'); document.getElementById('button-module').classList.remove('hidden'); initButton(); });
    document.getElementById('button-next-btn').addEventListener('click',()=>{ document.getElementById('button-module').classList.add('hidden'); document.getElementById('password-module').classList.remove('hidden'); initPassword(); });
    document.getElementById('restart-btn').addEventListener('click',()=>location.reload());
  </script>
</body>
</html>
