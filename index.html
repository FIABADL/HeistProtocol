<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hint Screen</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, Helvetica, sans-serif;
  }

  /* DISPLAY MODE */
  #display {
    display: none;
    width: 100%;
    height: 100%;
    background: white;
    color: black;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* 1:1 square container */
  #square {
    width: min(100vw, 100vh);
    height: min(100vw, 100vh);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5%;
    box-sizing: border-box;
  }

  #hintText {
    width: 100%;
    height: 100%;
    font-size: 6vw; /* JS will fit precisely */
    line-height: 1.1;
    text-align: center;
    white-space: pre-wrap;
    word-break: break-word;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* CONTROL MODE */
  #control {
    display: none;
    padding: 20px;
    box-sizing: border-box;
  }

  textarea {
    width: 100%;
    height: 180px;
    font-size: 20px;
    padding: 12px;
    box-sizing: border-box;
  }

  button {
    margin-top: 10px;
    margin-right: 10px;
    font-size: 18px;
    padding: 10px 18px;
    cursor: pointer;
  }

  /* Preset area */
  #presets {
    margin-top: 18px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 10px;
  }

  .presetBtn {
    font-size: 16px;
    padding: 12px 14px;
    text-align: left;
    line-height: 1.25;
  }

  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }
</style>
</head>
<body>

<div id="display">
  <div id="square">
    <div id="hintText"></div>
  </div>
</div>

<div id="control">
  <textarea id="input" placeholder="Type hint here..."></textarea>

  <div class="row">
    <button id="send">Send</button>
    <button id="clear">Clear</button>
  </div>

  <div id="presets"></div>
</div>

<script>
  const params = new URLSearchParams(location.search);
  const mode = params.get("mode");

  const displayDiv = document.getElementById("display");
  const controlDiv = document.getElementById("control");
  const hintText = document.getElementById("hintText");

  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const clearBtn = document.getElementById("clear");
  const presetsDiv = document.getElementById("presets");

  const STORAGE_KEY = "hint_screen_state_minimal_square_typing_presets";

  let channel = null;
  try {
    channel = new BroadcastChannel("hint_screen_channel_minimal_square_typing_presets");
  } catch (e) {
    channel = null;
  }

  function sendState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    if (channel) channel.postMessage(state);
    else localStorage.setItem(STORAGE_KEY + "_ping", Date.now());
  }

  // --- Typing animation control ---
  let typingTimer = null;
  let currentToken = 0;

  function startTyping(fullText) {
    currentToken++;
    const token = currentToken;
    if (typingTimer) clearInterval(typingTimer);

    hintText.textContent = "";
    if (!fullText) return;

    const baseDelay = 18; // typing speed (ms/char)

    let i = 0;
    typingTimer = setInterval(() => {
      if (token !== currentToken) {
        clearInterval(typingTimer);
        return;
      }
      hintText.textContent += fullText[i];
      i++;
      fitText();
      if (i >= fullText.length) clearInterval(typingTimer);
    }, baseDelay);
  }

  function applyState(state) {
    if (!state || state.type === "clear") {
      currentToken++;
      if (typingTimer) clearInterval(typingTimer);
      hintText.textContent = "";
      return;
    }
    if (state.type === "hint") {
      startTyping(state.text || "");
    }
  }

  // Auto-fit text inside the square
  function fitText() {
    if (!hintText.textContent) return;

    const container = document.getElementById("square");
    let size = container.clientWidth * 0.15; // start big
    hintText.style.fontSize = size + "px";

    while (
      (hintText.scrollWidth > hintText.clientWidth ||
       hintText.scrollHeight > hintText.clientHeight) &&
      size > 10
    ) {
      size -= 2;
      hintText.style.fontSize = size + "px";
    }
  }

  window.addEventListener("resize", () => fitText());

  // Preset hints (your list)
  const PRESETS = [
    "Look at the scenes that are circled on the scene list. Find those scenes in the script. The bolded word in each of those scenes correspond to a poster around the room...",
    "Each matching poster has an ON or OFF written on it. The two buttons on the lamp also turn it ON and OFF...",
    "The Ouija board has been damaged on purpose. Look closely at what’s scratched.",
    "Try those three numbers on the padlock on the nightstand.",
    "Add up the numbers on the dice faces for each stat.",
    "The book that has \"Part 1\" on it is \"The Boy and his Magic Book\". Is there any symbol on that desk that looks like a boy and his magic book?",
    "One side of those coasters look like they belong somewhere specific.",
    "If a rule says ‘don’t touch’ and it’s crossed out… maybe you should.",
    "Maybe we were just SITTING on where he went the whole time...",
    "The praying note isn’t just for story. Try doing what it says.",
    "Something changes when someone kneels.",
    "Have one player kneel at the altar, then place the eyes."
  ];

  function renderPresets() {
    presetsDiv.innerHTML = "";
    PRESETS.forEach((text, idx) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "presetBtn";
      btn.textContent = text;
      btn.onclick = () => {
        input.value = text;           // load into textbox
        input.focus();
        // move cursor to end
        input.setSelectionRange(input.value.length, input.value.length);
      };
      presetsDiv.appendChild(btn);
    });
  }

  if (mode === "display") {
    displayDiv.style.display = "flex";
    controlDiv.style.display = "none";

    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) applyState(JSON.parse(saved));

    if (channel) channel.onmessage = (e) => applyState(e.data);

    window.addEventListener("storage", () => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) applyState(JSON.parse(saved));
    });

  } else {
    controlDiv.style.display = "block";
    displayDiv.style.display = "none";

    renderPresets();

    sendBtn.onclick = () => sendState({ type: "hint", text: input.value });
    clearBtn.onclick = () => sendState({ type: "clear" });

    // Ctrl+Enter to send
    input.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "Enter") sendBtn.click();
    });
  }
</script>

</body>
</html>
